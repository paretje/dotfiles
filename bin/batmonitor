#!/bin/bash
check_battery() {
	message=$(acpi -b | sed -n '/unavailable/d;s/^Battery [0-9]: //;p')
	if [[ "${message:0:13}" != "Discharging, " ]]; then
		return
	fi

	percentage=$(echo "$message" | sed 's/^Discharging, \([0-9]\+\)%, \([0-9:]\+\) remaining$/\1/')
	test "$percentage" -gt 0 || notify-send -u critical "Something went wrong (batmonitor)" "$message"
	if [ "$percentage" -le 10 ]; then
		action=$(timeout 30s dunstify -u critical -A cancel,cancel "Battery Critically low, suspending in 30s!" "$message")
		if [ "$action" = "cancel" ] || acpi -b | grep -Fq 'Charging, '; then
			return
		fi
		if [ -x /bin/systemctl ]; then
			systemctl suspend
		elif [ -x /bin/loginctl ]; then
			loginctl suspend
		else
			sudo pm-suspend
		fi
	elif [ "$percentage" -le 15 ]; then
		notify-send -u critical "Battery getting very low" "$message"
	elif [ "$percentage" -le 20 ]; then
		notify-send -u low "Battery getting low" "$message"
	fi
}

while true; do
	check_battery
	sleep 2m
done
